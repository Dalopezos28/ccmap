{% extends 'base.html' %}
{% load static %}

{% block title %}Mapa de Comedores Comunitarios - Cali{% endblock %}

{% block content %}
<!-- Loader Mejorado -->
<div id="loader" class="loader">
    <div class="loader-spinner">
        <i class="fas fa-utensils fa-3x"></i>
        <div class="loader-progress">
            <div class="loader-progress-bar" id="loader-progress-bar"></div>
        </div>
        <p id="loader-message">Cargando comedores cercanos...</p>
        <p id="loader-submessage" style="font-size: 14px; color: var(--text-secondary); margin-top: 10px;">
            Esto puede tomar unos segundos
        </p>
    </div>
</div>

<!-- Header -->
<header class="header" role="banner">
    <div class="header-content">
        <div class="logo">
            <i class="fas fa-utensils" aria-hidden="true"></i>
            <h1>Comedores <span class="highlight">Cali</span></h1>
        </div>
        <nav class="header-actions" role="navigation" aria-label="Acciones principales">
            <a href="{% url 'network' %}" class="btn btn-network"
               title="Ver Red de Comedores"
               aria-label="Ver mapa de red de comedores"
               style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; display: inline-flex; align-items: center; gap: 8px;">
                <i class="fas fa-project-diagram" aria-hidden="true"></i>
                <span class="btn-text">Red de Comedores</span>
            </a>
            <button id="btn-emergencia" class="btn btn-danger-pulse"
                    title="¿Necesitas comer HOY?"
                    aria-label="Buscar comedores disponibles ahora con cupos">
                <i class="fas fa-exclamation-circle" aria-hidden="true"></i>
                <span class="btn-text">¡Necesito Comer HOY!</span>
            </button>
            <button id="btn-mi-ubicacion" class="btn btn-primary"
                    title="Mi ubicación"
                    aria-label="Encontrar comedores cerca de mi ubicación">
                <i class="fas fa-location-crosshairs" aria-hidden="true"></i>
                <span class="btn-text">Mi Ubicación</span>
            </button>
            <button id="btn-toggle-sidebar" class="btn btn-secondary"
                    title="Filtros"
                    aria-label="Abrir panel de filtros"
                    aria-expanded="false"
                    aria-controls="sidebar">
                <i class="fas fa-filter" aria-hidden="true"></i>
                <span class="btn-text">Filtros</span>
            </button>
            <button id="btn-modo-simple" class="btn btn-info"
                    title="Modo Simple"
                    aria-label="Ver lista simplificada de comedores">
                <i class="fas fa-th-large" aria-hidden="true"></i>
                <span class="btn-text">Modo Simple</span>
            </button>
            <button id="btn-alertas" class="btn btn-warning"
                    title="Recibir Alertas"
                    aria-label="Suscribirse a alertas de cupos disponibles"
                    style="background: linear-gradient(135deg, #ffb300, #f57c00); animation: pulse-important 2s ease-in-out infinite;">
                <i class="fas fa-bell" aria-hidden="true"></i>
                <span class="btn-text">Recibir Alertas</span>
            </button>
            <button id="btn-donaciones" class="btn btn-success"
                    title="Donar Ahora"
                    aria-label="Realizar una donación a comedores">
                <i class="fas fa-hand-holding-heart" aria-hidden="true"></i>
                <span class="btn-text">Donar Ahora</span>
            </button>
        </nav>
    </div>
</header>

<!-- Sidebar Filtros -->
<aside id="sidebar" class="sidebar" role="complementary" aria-label="Panel de filtros de búsqueda">
    <div class="sidebar-header">
        <h2><i class="fas fa-sliders" aria-hidden="true"></i> Filtros</h2>
        <button id="btn-close-sidebar" class="btn-close" aria-label="Cerrar panel de filtros">
            <i class="fas fa-times" aria-hidden="true"></i>
        </button>
    </div>

    <div class="sidebar-content" role="form" aria-label="Formulario de filtros">
        <!-- Búsqueda -->
        <div class="filter-group">
            <label for="search-input">
                <i class="fas fa-search"></i> Buscar
            </label>
            <input 
                type="text" 
                id="search-input" 
                class="form-control" 
                placeholder="Nombre o barrio..."
                autocomplete="off"
            >
            <div id="search-suggestions" class="suggestions"></div>
        </div>
        
        <!-- Estado -->
        <div class="filter-group">
            <label for="filter-estado">
                <i class="fas fa-clock"></i> Estado
            </label>
            <select id="filter-estado" class="form-control">
                <option value="todos">Todos</option>
                <option value="abierto">Abiertos ahora</option>
                <option value="cerrado">Cerrados</option>
            </select>
        </div>
        
        <!-- Tipo de comida -->
        <div class="filter-group">
            <label for="filter-tipo-comida">
                <i class="fas fa-drumstick-bite"></i> Tipo de Comida
            </label>
            <select id="filter-tipo-comida" class="form-control">
                <option value="">Todos los tipos</option>
                <option value="CASERA">Comida Casera</option>
                <option value="VEGETARIANA">Vegetariana</option>
                <option value="VEGANA">Vegana</option>
                <option value="MIXTA">Mixta</option>
                <option value="TIPICA">Típica Colombiana</option>
                <option value="INTERNACIONAL">Internacional</option>
            </select>
        </div>
        
        <!-- Calificación -->
        <div class="filter-group">
            <label for="filter-calificacion">
                <i class="fas fa-star"></i> Calificación Mínima
            </label>
            <select id="filter-calificacion" class="form-control">
                <option value="0">Todas</option>
                <option value="3">3+ estrellas</option>
                <option value="4">4+ estrellas</option>
                <option value="5">5 estrellas</option>
            </select>
        </div>
        
        <!-- Radio de búsqueda -->
        <div class="filter-group">
            <label for="filter-radio">
                <i class="fas fa-compass"></i> Radio de búsqueda
                <span id="radio-value">5 km</span>
            </label>
            <input 
                type="range" 
                id="filter-radio" 
                class="form-range" 
                min="1" 
                max="20" 
                value="5" 
                step="1"
            >
        </div>
        
        <!-- Botones de acción -->
        <div class="filter-actions">
            <button id="btn-aplicar-filtros" class="btn btn-success btn-block">
                <i class="fas fa-check"></i> Aplicar Filtros
            </button>
            <button id="btn-limpiar-filtros" class="btn btn-outline btn-block">
                <i class="fas fa-redo"></i> Limpiar
            </button>
        </div>
        
        <!-- Estadísticas -->
        <div class="stats-box">
            <h3><i class="fas fa-chart-bar"></i> Estadísticas</h3>
            <div class="stat-item">
                <span class="stat-label">Total comedores:</span>
                <span class="stat-value" id="stat-total">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Abiertos ahora:</span>
                <span class="stat-value stat-success" id="stat-abiertos">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">En el mapa:</span>
                <span class="stat-value stat-info" id="stat-visibles">0</span>
            </div>
        </div>
    </div>
</aside>

<!-- Mapa -->
<main class="main-content" role="main">
    <div id="map" class="map" role="application" aria-label="Mapa interactivo de comedores comunitarios en Cali"></div>

    <!-- Botones flotantes de accesibilidad -->
    <div class="float-buttons-group" aria-label="Opciones de accesibilidad">
        <button id="btn-alto-contraste" class="btn-float btn-contrast" title="Alto Contraste" aria-label="Activar modo de alto contraste">
            <i class="fas fa-adjust" aria-hidden="true"></i>
        </button>
        <button id="btn-ayuda" class="btn-float btn-help" title="Ayuda" aria-label="Abrir ayuda e instrucciones">
            <i class="fas fa-question" aria-hidden="true"></i>
        </button>
    </div>
</main>

<!-- Modal de Comedor -->
<div id="modal-comedor" class="modal">
    <div class="modal-content">
        <button class="modal-close" id="btn-close-modal">
            <i class="fas fa-times"></i>
        </button>
        
        <div class="modal-body">
            <div class="loader-small" id="modal-loader">
                <i class="fas fa-spinner fa-spin"></i>
            </div>
            
            <div id="modal-content-body" style="display: none;">
                <!-- Imagen -->
                <div class="modal-image" id="modal-image">
                    <img src="" alt="" id="modal-foto">
                    <div class="modal-badge" id="modal-estado-badge"></div>
                    <div class="modal-badge modal-badge-precio" id="modal-precio-badge"></div>
                    <div class="modal-badge modal-badge-cupos" id="modal-cupos-badge"></div>
                </div>
                
                <!-- Información -->
                <div class="modal-info">
                    <h2 id="modal-nombre"></h2>
                    <div class="modal-rating" id="modal-rating"></div>
                    
                    <!-- Detalles -->
                    <div class="modal-details">
                        <div class="detail-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <div>
                                <strong>Dirección</strong>
                                <p id="modal-direccion"></p>
                            </div>
                        </div>
                        
                        <div class="detail-item">
                            <i class="fas fa-clock"></i>
                            <div>
                                <strong>Horario</strong>
                                <p id="modal-horario"></p>
                            </div>
                        </div>
                        
                        <div class="detail-item" id="detail-telefono" style="display: none;">
                            <i class="fas fa-phone"></i>
                            <div>
                                <strong>Teléfono</strong>
                                <p id="modal-telefono"></p>
                            </div>
                        </div>
                        
                        <div class="detail-item">
                            <i class="fas fa-utensils"></i>
                            <div>
                                <strong>Tipo de Comida</strong>
                                <p id="modal-tipo-comida"></p>
                            </div>
                        </div>
                        
                        <div class="detail-item" id="detail-descripcion" style="display: none;">
                            <i class="fas fa-info-circle"></i>
                            <div>
                                <strong>Descripción</strong>
                                <p id="modal-descripcion"></p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Menú del día -->
                    <div class="modal-menu" id="modal-menu-container" style="display: none;">
                        <h3><i class="fas fa-calendar-day"></i> Menú del Día</h3>
                        <div id="modal-menu"></div>
                    </div>
                    
                    <!-- Comentarios recientes -->
                    <div class="modal-comentarios" id="modal-comentarios-container" style="display: none;">
                        <h3><i class="fas fa-comments"></i> Comentarios Recientes</h3>
                        <div id="modal-comentarios"></div>
                    </div>
                    
                    <!-- Botones de acción prioritarios -->
                    <div class="modal-actions-priority">
                        <a id="btn-llamar" class="btn btn-call btn-block" href="tel:">
                            <i class="fas fa-phone-alt"></i> LLAMAR AHORA
                        </a>
                        <a id="btn-whatsapp" class="btn btn-whatsapp btn-block" target="_blank" rel="noopener" style="display: none;">
                            <i class="fab fa-whatsapp"></i> WhatsApp
                        </a>
                    </div>
                    
                    <!-- Información de cupos y disponibilidad -->
                    <div class="info-cupos" id="info-cupos" style="display: none;">
                        <div class="cupos-header">
                            <i class="fas fa-users"></i>
                            <strong>Disponibilidad</strong>
                        </div>
                        <div class="cupos-content">
                            <div class="cupos-item">
                                <span>Cupos disponibles:</span>
                                <span id="cupos-numero" class="cupos-valor"></span>
                            </div>
                            <div class="cupos-item" id="cola-info" style="display: none;">
                                <span>Tiempo de espera:</span>
                                <span id="cola-tiempo" class="cupos-valor"></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Transporte público -->
                    <div class="info-transporte" id="info-transporte" style="display: none;">
                        <h3><i class="fas fa-bus"></i> Cómo Llegar en Transporte Público</h3>
                        <div class="transporte-content">
                            <div class="transporte-item">
                                <i class="fas fa-route"></i>
                                <div>
                                    <strong>Rutas disponibles</strong>
                                    <p id="transporte-rutas"></p>
                                </div>
                            </div>
                            <div class="transporte-item" id="parada-info" style="display: none;">
                                <i class="fas fa-map-pin"></i>
                                <div>
                                    <strong>Parada más cercana</strong>
                                    <p id="transporte-parada"></p>
                                    <small id="transporte-distancia"></small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Servicios y accesibilidad -->
                    <div class="info-servicios" id="info-servicios">
                        <h3><i class="fas fa-check-circle"></i> Servicios Disponibles</h3>
                        <div class="servicios-grid" id="servicios-grid"></div>
                    </div>
                    
                    <!-- Acciones -->
                    <div class="modal-actions">
                        <a id="btn-como-llegar" class="btn btn-primary" target="_blank" rel="noopener">
                            <i class="fas fa-directions"></i> Cómo Llegar
                        </a>
                        <button id="btn-compartir" class="btn btn-outline">
                            <i class="fas fa-share-alt"></i> Compartir
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Ayuda -->
<div id="modal-ayuda" class="modal">
    <div class="modal-content modal-small">
        <button class="modal-close" onclick="cerrarModalAyuda()">
            <i class="fas fa-times"></i>
        </button>
        <div class="modal-body">
            <h2><i class="fas fa-question-circle"></i> Ayuda</h2>
            <div class="ayuda-content">
                <h3>¿Cómo usar el mapa?</h3>
                <ul>
                    <li><i class="fas fa-mouse-pointer"></i> Haz clic en un marcador para ver detalles</li>
                    <li><i class="fas fa-search-location"></i> Usa los filtros para encontrar comedores específicos</li>
                    <li><i class="fas fa-location-crosshairs"></i> Presiona "Mi Ubicación" para ver comedores cercanos</li>
                    <li><i class="fas fa-exclamation-circle"></i> Botón rojo "¡Necesito Comer HOY!" muestra comedores disponibles ahora</li>
                    <li><i class="fas fa-phone"></i> Botón "LLAMAR AHORA" para contacto directo</li>
                </ul>
                
                <h3>Leyenda de Marcadores</h3>
                <div class="leyenda">
                    <div class="leyenda-item">
                        <span class="marker-dot marker-open"></span> Abierto ahora con cupos
                    </div>
                    <div class="leyenda-item">
                        <span class="marker-dot marker-closed"></span> Cerrado
                    </div>
                </div>

                <h3>Atajos de Teclado</h3>
                <ul>
                    <li><i class="fas fa-keyboard"></i> <strong>Esc</strong> - Cerrar modales o panel de filtros</li>
                    <li><i class="fas fa-keyboard"></i> <strong>Ctrl/Cmd + F</strong> - Buscar comedores</li>
                    <li><i class="fas fa-keyboard"></i> <strong>Ctrl/Cmd + H</strong> - Abrir ayuda</li>
                    <li><i class="fas fa-keyboard"></i> <strong>Ctrl/Cmd + K</strong> - Activar alto contraste</li>
                    <li><i class="fas fa-keyboard"></i> <strong>Tab</strong> - Navegar entre elementos</li>
                </ul>

                <h3>Accesibilidad</h3>
                <ul>
                    <li><i class="fas fa-adjust"></i> Botón morado para activar modo de alto contraste</li>
                    <li><i class="fas fa-keyboard"></i> Navegación completa por teclado</li>
                    <li><i class="fas fa-volume-up"></i> Compatible con lectores de pantalla</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Modo Simple -->
<div id="modal-simple" class="modal">
    <div class="modal-content modal-simple">
        <button class="modal-close" onclick="cerrarModoSimple()">
            <i class="fas fa-times"></i>
        </button>
        <div class="modal-body">
            <h2 class="simple-title"><i class="fas fa-list"></i> Comedores Cercanos</h2>
            <div id="lista-simple" class="lista-simple">
                <!-- Se llenará con JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Modal de Alertas -->
<div id="modal-alertas" class="modal">
    <div class="modal-content modal-small">
        <button class="modal-close" id="btn-close-modal-alertas" aria-label="Cerrar formulario de alertas">
            <i class="fas fa-times"></i>
        </button>
        <div class="modal-body">
            <h2 style="color: var(--primary-color); margin-bottom: 10px;">
                <i class="fas fa-bell"></i> Recibir Alertas
            </h2>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">
                Recibe notificaciones cuando haya cupos disponibles en comedores cerca de ti
            </p>

            <form id="form-alertas">
                <div class="filter-group">
                    <label for="alerta-nombre">
                        <i class="fas fa-user"></i> Nombre
                    </label>
                    <input type="text" id="alerta-nombre" class="form-control"
                           placeholder="Tu nombre completo" required>
                </div>

                <div class="filter-group">
                    <label for="alerta-telefono">
                        <i class="fas fa-phone"></i> Teléfono / WhatsApp
                    </label>
                    <input type="tel" id="alerta-telefono" class="form-control"
                           placeholder="+57 300 123 4567" required>
                    <small style="color: var(--text-secondary); font-size: 12px;">
                        Formato: +57 XXX XXX XXXX
                    </small>
                </div>

                <div class="filter-group">
                    <label for="alerta-email">
                        <i class="fas fa-envelope"></i> Email (opcional)
                    </label>
                    <input type="email" id="alerta-email" class="form-control"
                           placeholder="tu@email.com">
                </div>

                <div class="filter-group">
                    <label for="alerta-tipo">
                        <i class="fas fa-bell"></i> Tipo de Alerta
                    </label>
                    <select id="alerta-tipo" class="form-control">
                        <option value="CUPOS_BAJOS">Cupos Bajos en mi Barrio</option>
                        <option value="NUEVO_COMEDOR">Nuevo Comedor Cercano</option>
                        <option value="MENU_DIA">Menú del Día</option>
                        <option value="APERTURA">Comedor Abierto Ahora</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="alerta-canal">
                        <i class="fas fa-comment"></i> Preferencia de Canal
                    </label>
                    <select id="alerta-canal" class="form-control">
                        <option value="WHATSAPP">WhatsApp</option>
                        <option value="SMS">SMS</option>
                        <option value="EMAIL">Email</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="alerta-barrios">
                        <i class="fas fa-map-marker-alt"></i> Barrios de Interés
                    </label>
                    <input type="text" id="alerta-barrios" class="form-control"
                           placeholder="Ej: San Bosco, Siloé, Alfonso López">
                    <small style="color: var(--text-secondary); font-size: 12px;">
                        Separados por comas
                    </small>
                </div>

                <div class="filter-group">
                    <label for="alerta-radio">
                        <i class="fas fa-compass"></i> Radio de Búsqueda
                        <span id="alerta-radio-value" style="margin-left: auto; color: var(--primary-color); font-weight: 700;">5 km</span>
                    </label>
                    <input type="range" id="alerta-radio" class="form-range"
                           min="1" max="20" value="5" step="1">
                </div>

                <div class="filter-actions">
                    <button type="submit" class="btn btn-success btn-block">
                        <i class="fas fa-check"></i> ¡Suscribirme Ahora!
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Donaciones (Wizard de 3 Pasos) -->
<div id="modal-donaciones" class="modal">
    <div class="modal-content">
        <button class="modal-close" id="btn-close-modal-donaciones" aria-label="Cerrar formulario de donaciones">
            <i class="fas fa-times"></i>
        </button>
        <div class="modal-body">
            <h2 style="color: var(--success-color); margin-bottom: 10px;">
                <i class="fas fa-hand-holding-heart"></i> Realizar una Donación
            </h2>

            <!-- Progress bar -->
            <div class="wizard-progress">
                <div class="wizard-step active" data-step="1">
                    <div class="wizard-step-number">1</div>
                    <span>Donante</span>
                </div>
                <div class="wizard-step" data-step="2">
                    <div class="wizard-step-number">2</div>
                    <span>Donación</span>
                </div>
                <div class="wizard-step" data-step="3">
                    <div class="wizard-step-number">3</div>
                    <span>Ubicación</span>
                </div>
            </div>

            <form id="form-donaciones">
                <!-- PASO 1: Datos del Donante -->
                <div class="wizard-content" id="wizard-step-1">
                    <h3 style="color: var(--primary-color); margin-bottom: 20px;">
                        Datos del Donante
                    </h3>

                    <div class="filter-group">
                        <label for="donacion-nombre">
                            <i class="fas fa-user"></i> Nombre / Organización
                        </label>
                        <input type="text" id="donacion-nombre" class="form-control"
                               placeholder="Tu nombre o empresa" required>
                    </div>

                    <div class="filter-group">
                        <label for="donacion-telefono">
                            <i class="fas fa-phone"></i> Teléfono
                        </label>
                        <input type="tel" id="donacion-telefono" class="form-control"
                               placeholder="+57 300 123 4567" required>
                    </div>

                    <div class="filter-group">
                        <label for="donacion-email">
                            <i class="fas fa-envelope"></i> Email (opcional)
                        </label>
                        <input type="email" id="donacion-email" class="form-control"
                               placeholder="tu@email.com">
                    </div>

                    <div class="filter-actions">
                        <button type="button" class="btn btn-primary btn-block" onclick="siguientePaso(2)">
                            Siguiente <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- PASO 2: Detalles de la Donación -->
                <div class="wizard-content" id="wizard-step-2" style="display: none;">
                    <h3 style="color: var(--primary-color); margin-bottom: 20px;">
                        Detalles de la Donación
                    </h3>

                    <div class="filter-group">
                        <label for="donacion-tipo">
                            <i class="fas fa-box"></i> Tipo de Donación
                        </label>
                        <select id="donacion-tipo" class="form-control">
                            <option value="ALIMENTOS">Alimentos No Perecederos</option>
                            <option value="PERECEDEROS">Alimentos Perecederos</option>
                            <option value="DINERO">Dinero en Efectivo</option>
                            <option value="INSUMOS">Insumos de Cocina</option>
                            <option value="VOLUNTARIADO">Tiempo como Voluntario</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="donacion-descripcion">
                            <i class="fas fa-align-left"></i> Descripción
                        </label>
                        <textarea id="donacion-descripcion" class="form-control" rows="3"
                                  placeholder="Ej: 20 kg de arroz, 10 kg de frijol, 5 litros de aceite" required></textarea>
                    </div>

                    <div class="filter-group">
                        <label for="donacion-cantidad">
                            <i class="fas fa-weight"></i> Cantidad (kg) - Opcional
                        </label>
                        <input type="number" id="donacion-cantidad" class="form-control"
                               placeholder="Peso aproximado en kilogramos" min="0" step="0.1">
                    </div>

                    <div class="filter-group">
                        <label for="donacion-valor">
                            <i class="fas fa-dollar-sign"></i> Valor Estimado (COP) - Opcional
                        </label>
                        <input type="number" id="donacion-valor" class="form-control"
                               placeholder="Valor en pesos colombianos" min="0">
                    </div>

                    <div class="filter-actions" style="display: flex; gap: 10px;">
                        <button type="button" class="btn btn-outline" onclick="siguientePaso(1)" style="flex: 1;">
                            <i class="fas fa-arrow-left"></i> Anterior
                        </button>
                        <button type="button" class="btn btn-primary" onclick="siguientePaso(3)" style="flex: 1;">
                            Siguiente <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- PASO 3: Ubicación y Confirmación -->
                <div class="wizard-content" id="wizard-step-3" style="display: none;">
                    <h3 style="color: var(--primary-color); margin-bottom: 20px;">
                        Ubicación y Entrega
                    </h3>

                    <div class="filter-group">
                        <label for="donacion-direccion">
                            <i class="fas fa-map-marker-alt"></i> Dirección de Recolección
                        </label>
                        <textarea id="donacion-direccion" class="form-control" rows="2"
                                  placeholder="Dejar vacío si llevarás la donación tú mismo"></textarea>
                        <small style="color: var(--text-secondary); font-size: 12px;">
                            Opcional - Si necesitas que recojamos la donación
                        </small>
                    </div>

                    <div class="filter-group">
                        <label for="donacion-barrio">
                            <i class="fas fa-map"></i> Barrio
                        </label>
                        <input type="text" id="donacion-barrio" class="form-control"
                               placeholder="Tu barrio">
                    </div>

                    <div class="filter-group">
                        <label>
                            <i class="fas fa-location-dot"></i> Ubicación en el Mapa
                        </label>
                        <button type="button" class="btn btn-info btn-block" onclick="obtenerUbicacionDonacion()">
                            <i class="fas fa-crosshairs"></i> Usar Mi Ubicación Actual
                        </button>
                        <small id="coords-donacion-display" style="color: var(--success-color); font-size: 12px; display: none;">
                            ✓ Ubicación guardada
                        </small>
                    </div>

                    <div class="filter-actions" style="display: flex; gap: 10px;">
                        <button type="button" class="btn btn-outline" onclick="siguientePaso(2)" style="flex: 1;">
                            <i class="fas fa-arrow-left"></i> Anterior
                        </button>
                        <button type="submit" class="btn btn-success" style="flex: 1;">
                            <i class="fas fa-check"></i> Enviar Donación
                        </button>
                    </div>
                </div>
            </form>

            <!-- Resultado del matching -->
            <div id="donacion-resultado" style="display: none; margin-top: 20px; padding: 20px; background: var(--dark-bg); border-radius: var(--border-radius); border: 2px solid var(--success-color);">
                <h3 style="color: var(--success-color); margin-bottom: 15px;">
                    <i class="fas fa-check-circle"></i> ¡Donación Registrada!
                </h3>
                <p id="donacion-resultado-texto" style="color: var(--text-primary);"></p>
                <button type="button" class="btn btn-primary btn-block" onclick="cerrarModalDonaciones()" style="margin-top: 15px;">
                    Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Configuración global
    window.CALI_CENTER = {lat: 3.4516, lng: -76.5320};
    window.API_BASE_URL = '/api';
</script>
{% endblock %}

